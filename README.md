# Telegram Planfix Bot

Телеграм-бот для работы с заявками в Planfix. Бот позволяет сотрудникам ресторанов создавать и отслеживать обращения, а исполнителям — получать уведомления и управлять задачами.

## Структура проекта

- `main.py` — точка входа для запуска бота (polling) и webhook сервера одновременно.
- `webhook_server.py` — сервер для приёма webhook'ов от Planfix.
- `user_handlers.py`, `executor_handlers.py` — обработчики пользовательских сценариев.
- `planfix_api.py`, `planfix_client.py` — асинхронный клиент Planfix.
- `planfix_sync.py` — сервис периодического опроса Planfix.
- `services/` — вспомогательные сервисы (например, асинхронная обёртка БД).
- `config/` — конфигурация и справочники (франшизы, шаблоны задач).
- `tests/` — автоматические тесты.

## Конфигурация статусов Planfix

Начиная с текущей версии, бот автоматически определяет идентификаторы статусов процесса задач Planfix:

- При старте приложения выполняется запрос к Planfix API, статусы кэшируются в таблице `planfix_task_statuses` и используются по всему боту.
- Значения `PLANFIX_STATUS_ID_*` в `.env` теперь необязательны. Их можно оставить пустыми — бот заполнит ID самостоятельно.
- При необходимости можно переопределить конкретные статусы, задав их явно в `.env`; эти значения будут использованы вместо автоматически полученных.
- `DIRECTORY_RESTAURANTS_ID` также необязателен: если его нет, бот использует ID контакта ресторана как ключ справочника.

Для корректной работы требуется указать `PLANFIX_TASK_PROCESS_ID`, а также учётные данные API (ключ, секрет и идентификатор источника).

### Как получить DIRECTORY_RESTAURANTS_ID?

Если вы используете справочник ресторанов в Planfix, вы можете получить его ID с помощью утилиты:

```bash
python list_directories.py
```

Эта команда выведет список всех справочников с их ID и названиями. Найдите нужный справочник и скопируйте его ID в файл `.env`:

```
DIRECTORY_RESTAURANTS_ID=123
```

**Примечание:** Если `DIRECTORY_RESTAURANTS_ID` не указан, бот будет использовать ID контакта ресторана как ключ справочника (это работает, если ключи справочника совпадают с ID контактов).

## Подготовка окружения

1. Склонировать репозиторий и перейти в директорию проекта.
2. Создать виртуальное окружение и установить зависимости:
   ```bash
   # Linux/macOS
   python3 -m venv venv
   source venv/bin/activate
   pip install -r requirements.txt
   
   # Windows
   python -m venv venv
   venv\Scripts\activate
   pip install -r requirements.txt
   ```
   
   **Примечание:** На Linux обычно используется `python3`, на Windows - `python`.
3. Скопировать файл `env.example` в `.env` и заполнить значения.
   ```bash
   cp env.example .env
   ```

## Запуск бота

### Активация виртуального окружения

Перед запуском необходимо активировать виртуальное окружение:

```bash
# Linux/macOS
source venv/bin/activate

# Windows
venv\Scripts\activate
```

### Запуск

Бот запускается вместе с webhook сервером через `main.py`:

```bash
# После активации виртуального окружения
python3 main.py  # Linux/macOS
# или
python main.py   # Windows (после активации venv)
```

Логи отображаются в реальном времени в консоли.

### Параметры запуска

```bash
# Запуск с настройками по умолчанию (webhook на 127.0.0.1:8080)
python3 main.py  # Linux/macOS

# Указать порт webhook
python3 main.py --webhook-port 9000

# Указать хост webhook (0.0.0.0 для доступа извне)
python3 main.py --webhook-host 0.0.0.0

# Комбинация параметров
python3 main.py --webhook-host 127.0.0.1 --webhook-port 8080
```

**Важно:** На Linux используйте `python3`, на Windows (после активации venv) можно использовать `python`.

### Альтернативный запуск через скрипт

Можно использовать скрипт `start_bot.sh`, который автоматически активирует виртуальное окружение:

```bash
# Linux/macOS
./start_bot.sh

# С параметрами
./start_bot.sh --webhook-port 9000
```

## Установка как системной службы (systemd)

Для автоматического запуска бота при перезагрузке сервера и работы в фоновом режиме рекомендуется установить его как systemd службу.

### Требования

- Linux система с systemd
- Права root (sudo) для установки службы
- Виртуальное окружение создано и зависимости установлены

### Установка

1. Убедитесь, что вы находитесь в корневой директории проекта:
   ```bash
   cd /home/dev_bot/telegram_planfix_bot
   ```

2. Запустите скрипт установки с правами root:
   ```bash
   sudo ./install_service.sh
   ```

   Скрипт автоматически:
   - Определит пользователя и группу проекта
   - Найдет виртуальное окружение (venv или .venv)
   - Создаст директорию для логов
   - Создаст и установит systemd service файл
   - Включит автозапуск при загрузке системы

3. Запустите службу:
   ```bash
   sudo systemctl start telegram-planfix-bot
   ```

4. Проверьте статус:
   ```bash
   sudo systemctl status telegram-planfix-bot
   ```

### Управление службой

```bash
# Запуск
sudo systemctl start telegram-planfix-bot

# Остановка
sudo systemctl stop telegram-planfix-bot

# Перезапуск
sudo systemctl restart telegram-planfix-bot

# Просмотр статуса
sudo systemctl status telegram-planfix-bot

# Просмотр логов в реальном времени
sudo journalctl -u telegram-planfix-bot -f

# Просмотр последних 100 строк логов
sudo journalctl -u telegram-planfix-bot -n 100

# Включить автозапуск при загрузке (уже включен после install_service.sh)
sudo systemctl enable telegram-planfix-bot

# Отключить автозапуск
sudo systemctl disable telegram-planfix-bot
```

### Проверка работы

После установки служба будет:
- ✅ Автоматически запускаться при перезагрузке сервера
- ✅ Автоматически перезапускаться при сбоях (через 10 секунд)
- ✅ Работать в фоновом режиме
- ✅ Логироваться в systemd journal

Вы можете безопасно завершать сеанс SSH и перезагружать сервер — бот будет работать автоматически.

## Тестирование и статический анализ

- Запуск тестов:
  ```bash
  pytest
  ```
- Проверка кода линтером:
  ```bash
  ruff check .
  ```

## CI

Проект содержит GitHub Actions workflow (`.github/workflows/ci.yml`), который устанавливает зависимости, выполняет линтер и запускает тесты при каждом push / pull request.

## Обновление справочников и шаблонов

Справочные данные по концепциям и контактам, а также список шаблонов задач, находятся в `config/__init__.py`:

- `FRANCHISE_GROUPS` — концепции и их рестораны.
- `PLANFIX_SE_TEMPLATES` / `PLANFIX_IT_TEMPLATES` — шаблоны задач (Служба эксплуатации и ИТ-отдел).

При изменении структуры важно дополнительно исправить тесты (`tests/test_config.py`), чтобы покрытие всегда отражало актуальные данные.


