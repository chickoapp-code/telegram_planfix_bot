# Telegram Planfix Bot

Телеграм-бот для работы с заявками в Planfix. Бот позволяет сотрудникам ресторанов создавать и отслеживать обращения, а исполнителям — получать уведомления и управлять задачами.

## Структура проекта

- `main.py` — точка входа бота (polling).
- `webhook_server.py` — вспомогательный сервер для приёма webhook'ов Planfix (опционально).
- `user_handlers.py`, `executor_handlers.py` — обработчики пользовательских сценариев.
- `planfix_api.py`, `planfix_client.py` — асинхронный клиент Planfix.
- `planfix_sync.py` — сервис периодического опроса Planfix.
- `services/` — вспомогательные сервисы (например, асинхронная обёртка БД).
- `config/` — конфигурация и справочники (франшизы, шаблоны задач).
- `tests/` — автоматические тесты.

## Конфигурация статусов Planfix

Начиная с текущей версии, бот автоматически определяет идентификаторы статусов процесса задач Planfix:

- При старте приложения выполняется запрос к Planfix API, статусы кэшируются в таблице `planfix_task_statuses` и используются по всему боту.
- Значения `PLANFIX_STATUS_ID_*` в `.env` теперь необязательны. Их можно оставить пустыми — бот заполнит ID самостоятельно.
- При необходимости можно переопределить конкретные статусы, задав их явно в `.env`; эти значения будут использованы вместо автоматически полученных.
- `DIRECTORY_RESTAURANTS_ID` также необязателен: если его нет, бот использует ID контакта ресторана как ключ справочника.

Для корректной работы требуется указать `PLANFIX_TASK_PROCESS_ID`, а также учётные данные API (ключ, секрет и идентификатор источника).

### Как получить DIRECTORY_RESTAURANTS_ID?

Если вы используете справочник ресторанов в Planfix, вы можете получить его ID с помощью утилиты:

```bash
python list_directories.py
```

Эта команда выведет список всех справочников с их ID и названиями. Найдите нужный справочник и скопируйте его ID в файл `.env`:

```
DIRECTORY_RESTAURANTS_ID=123
```

**Примечание:** Если `DIRECTORY_RESTAURANTS_ID` не указан, бот будет использовать ID контакта ресторана как ключ справочника (это работает, если ключи справочника совпадают с ID контактов).

## Подготовка окружения

1. Склонировать репозиторий и перейти в директорию проекта.
2. Создать виртуальное окружение и установить зависимости:
   ```bash
   python -m venv .venv
   source .venv/bin/activate  # Windows: .venv\Scripts\activate
   pip install -r requirements.txt
   ```
3. Скопировать файл `env.example` в `.env` и заполнить значения.
   ```bash
   cp env.example .env
   ```

## Запуск бота

```bash
python main.py
```

При необходимости можно запускать webhook-сервер:

```bash
python webhook_server.py
```

## Тестирование и статический анализ

- Запуск тестов:
  ```bash
  pytest
  ```
- Проверка кода линтером:
  ```bash
  ruff check .
  ```

## CI

Проект содержит GitHub Actions workflow (`.github/workflows/ci.yml`), который устанавливает зависимости, выполняет линтер и запускает тесты при каждом push / pull request.

## Обновление справочников и шаблонов

Справочные данные по концепциям и контактам, а также список шаблонов задач, находятся в `config/__init__.py`:

- `FRANCHISE_GROUPS` — концепции и их рестораны.
- `PLANFIX_SE_TEMPLATES` / `PLANFIX_IT_TEMPLATES` — шаблоны задач (Служба эксплуатации и ИТ-отдел).

При изменении структуры важно дополнительно исправить тесты (`tests/test_config.py`), чтобы покрытие всегда отражало актуальные данные.


