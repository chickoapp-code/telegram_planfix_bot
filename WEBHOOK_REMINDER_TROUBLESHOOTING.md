# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å webhook task.reminder

## –ü—Ä–æ–±–ª–µ–º–∞
–ù–µ –ø—Ä–∏—Ö–æ–¥—è—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ webhook –¥–ª—è —Å–æ–±—ã—Ç–∏—è `task.reminder`.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ webhook –æ—Ç Planfix

–°–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Planfix, webhook –¥–ª—è `task.reminder` –∏–º–µ–µ—Ç —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É:

```json
{
  "event": "task.reminder",
  "task": {
    "id": "123"  // –∏–ª–∏ "task:123" –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ
  }
}
```

## –®–∞–≥–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è webhook

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –≤—Ö–æ–¥—è—â–∏—Ö webhook:

```bash
sudo journalctl -u telegram-planfix-bot -f | grep -E "(webhook|reminder|task\.reminder)"
```

–ò–ª–∏ –≤—Å–µ –ª–æ–≥–∏:
```bash
sudo journalctl -u telegram-planfix-bot -f
```

**–ß—Ç–æ –∏—Å–∫–∞—Ç—å:**
- `Received webhook: method=POST, content_type=...` - webhook –ø–æ–ª—É—á–µ–Ω
- `Parsed webhook data: ...` - –¥–∞–Ω–Ω—ã–µ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω—ã
- `üîî Received task.reminder webhook: ...` - —Å–æ–±—ã—Ç–∏–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ
- `üîî Processing task.reminder webhook. Data: ...` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—á–∞–ª–∞—Å—å

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhook –≤ Planfix

1. –í–æ–π–¥–∏—Ç–µ –≤ Planfix
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π/webhook
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ:
   - Webhook URL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π: `http://your-server:8080/planfix/webhook`
   - –°–æ–±—ã—Ç–∏–µ `task.reminder` –≤–∫–ª—é—á–µ–Ω–æ
   - Webhook –∞–∫—Ç–∏–≤–µ–Ω

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞
sudo systemctl status telegram-planfix-bot

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞
sudo netstat -tlnp | grep 8080
# –∏–ª–∏
sudo ss -tlnp | grep 8080
```

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ webhook –≤—Ä—É—á–Ω—É—é

–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π webhook:

```bash
curl -X POST http://localhost:8080/planfix/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "event": "task.reminder",
    "task": {
      "id": "123"
    }
  }'
```

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
```bash
sudo journalctl -u telegram-planfix-bot -n 50
```

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö

–í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤–∏–¥–Ω–æ:
- –ö–∞–∫–æ–π —Ñ–æ—Ä–º–∞—Ç `task.id` –ø—Ä–∏—Ö–æ–¥–∏—Ç (—Å—Ç—Ä–æ–∫–∞, —á–∏—Å–ª–æ, "task:123")
- –ï—Å—Ç—å –ª–∏ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è
- –ü—Ä–æ—Ö–æ–¥–∏—Ç –ª–∏ –∑–∞–¥–∞—á–∞ —Ñ–∏–ª—å—Ç—Ä—ã

**–ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤:**

‚úÖ **–£—Å–ø–µ—à–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:**
```
üîî Received task.reminder webhook: {"event": "task.reminder", "task": {"id": "123"}}
üîî Processing task.reminder webhook. Data: {...}
üìã Task reminder: raw task_id=123, type=<class 'str'>
‚úÖ Task reminder: normalized task_id=123
üîî Reminder for unassigned task 123 - resending notifications to executors
‚úÖ Successfully sent reminder notifications for task 123
```

‚ùå **–ü—Ä–æ–±–ª–µ–º—ã:**

**–ù–µ—Ç –ø–æ–ª—è task:**
```
‚ö†Ô∏è No 'task' field in reminder webhook. Data keys: ['event']
```

**–ù–µ—Ç task.id:**
```
‚ö†Ô∏è Incomplete task data in reminder webhook: task object keys: ['name'], full data: {...}
```

**–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç task.id:**
```
‚ùå Invalid task_id format in reminder: {{–ó–∞–¥–∞—á–∞.–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä}} (type: <class 'str'>), error: ...
```

### 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤

Webhook –º–æ–∂–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å, –Ω–æ –∑–∞–¥–∞—á–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–∞:

- **–§–∏–ª—å—Ç—Ä `_should_process_task`** - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∑–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
- **–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏** - –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ —É–∂–µ "–í —Ä–∞–±–æ—Ç–µ", –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
- **–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏** - –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

–í –ª–æ–≥–∞—Ö –±—É–¥—É—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:
- `Task {id} reminder skipped by filter`
- `Task {id} reminder skipped: task is already in progress`
- `Task {id} reminder skipped: task has {n} assignee(s) in Planfix`

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### 1. Webhook –Ω–µ –¥–æ—Ö–æ–¥–∏—Ç –¥–æ —Å–µ—Ä–≤–µ—Ä–∞

**–ü—Ä–∏—á–∏–Ω—ã:**
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Planfix
- –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ (firewall, nginx –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
- Webhook –æ—Ç–∫–ª—é—á–µ–Ω –≤ Planfix

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Planfix
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞: `curl http://your-server:8080/planfix/webhook`
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ nginx –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è webhook

### 2. Webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç, –Ω–æ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω—ã:**
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–∞—Ä—Å–∏–Ω–≥–æ–º JSON
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ `event`

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `sudo journalctl -u telegram-planfix-bot -n 100 | grep -i "parsed\|event\|reminder"`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –¥–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å –ø–æ–ª–µ `"event": "task.reminder"`

### 3. Webhook —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç—Å—è, –Ω–æ –∑–∞–¥–∞—á–∞ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω—ã:**
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç `task.id` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `{{–ó–∞–¥–∞—á–∞.–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä}}` –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ ID)
- –ó–∞–¥–∞—á–∞ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–∞
- –ó–∞–¥–∞—á–∞ —É–∂–µ –≤ —Ä–∞–±–æ—Ç–µ

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏: `sudo journalctl -u telegram-planfix-bot -n 100 | grep -i "task reminder"`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `task.id` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–µ–∞–ª—å–Ω—ã–π ID, –∞ –Ω–µ —à–∞–±–ª–æ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ –≤ Planfix

### 4. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω—ã:**
- –ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
- –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –ü—Ä–æ–±–ª–µ–º–∞ —Å Telegram API

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `sudo journalctl -u telegram-planfix-bot -n 100 | grep -i "notify\|notification"`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –±–æ—Ç –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π

## –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞ –≤ –ª–æ–≥–∞—Ö –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ:

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ webhook:**
   ```
   Received webhook: method=POST, content_type=application/json, body_length=123
   ```

2. **–†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
   ```
   Parsed webhook data: {
     "event": "task.reminder",
     "task": {
       "id": "123"
     }
   }
   ```

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ reminder:**
   ```
   üîî Received task.reminder webhook: {...}
   üîî Processing task.reminder webhook. Data: {...}
   üìã Task reminder: raw task_id=123, type=<class 'str'>
   ‚úÖ Task reminder: normalized task_id=123
   ```

4. **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
   ```
   üîî Reminder for unassigned task 123 - resending notifications to executors
   ‚úÖ Successfully sent reminder notifications for task 123
   ```

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

```bash
# –í—Å–µ –ª–æ–≥–∏ —Å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º reminder
sudo journalctl -u telegram-planfix-bot | grep -i reminder

# –ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤
sudo journalctl -u telegram-planfix-bot -n 100

# –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
sudo journalctl -u telegram-planfix-bot -f

# –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏
sudo journalctl -u telegram-planfix-bot -p err

# –õ–æ–≥–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
sudo journalctl -u telegram-planfix-bot --since "1 hour ago"
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhook –≤ Planfix

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ webhook URL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ `task.reminder` –≤–∫–ª—é—á–µ–Ω–æ
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ —à–∞–±–ª–æ–Ω–µ webhook –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç:
   ```json
   {
     "event": "task.reminder",
     "task": {
       "id": "{{–ó–∞–¥–∞—á–∞.–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä}}"
     }
   }
   ```
   
   **–í–ê–ñ–ù–û:** `{{–ó–∞–¥–∞—á–∞.–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä}}` - —ç—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è Planfix, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π ID –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ webhook.

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å: `sudo systemctl restart telegram-planfix-bot`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `sudo journalctl -u telegram-planfix-bot -f`
4. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ Planfix
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook

